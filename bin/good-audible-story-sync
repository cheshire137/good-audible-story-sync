#!/usr/bin/env ruby
# encoding: utf-8

require_relative "../lib/good_audible_story_sync"

options = GoodAudibleStorySync::Options.parse(script_name: __FILE__)

audible_auth = GoodAudibleStorySync::Audible::AuthFlow.run(credentials_file: options.credentials_file)
exit 1 if audible_auth.nil?

audible_client = GoodAudibleStorySync::Audible::Client.new(auth: audible_auth, options: options)

unless audible_auth.loaded_from_file?
  puts "#{GoodAudibleStorySync::Util::INFO_EMOJI} Getting Audible user profile..."
  user_profile = audible_client.get_user_profile
  puts user_profile.to_s(indent_level: 1)
end

library = GoodAudibleStorySync::Audible::Library.load_with_finish_times(client: audible_client,
  options: options)
puts library.to_s

puts "\n#{GoodAudibleStorySync::Util::INFO_EMOJI} Logging in to Storygraph..."
storygraph_auth = GoodAudibleStorySync::Storygraph::AuthFlow.run(
  credentials_file: options.credentials_file
)
exit 1 unless storygraph_auth

library_item = library.items.detect { |item| item.isbn }
if library_item
  storygraph_client = GoodAudibleStorySync::Storygraph::Client.new(auth: storygraph_auth)
  storygraph_book = storygraph_client.find_by_isbn(library_item.isbn)
  puts storygraph_book.inspect
end
