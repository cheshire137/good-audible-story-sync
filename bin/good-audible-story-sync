#!/usr/bin/env ruby
# encoding: utf-8

require_relative "../lib/good_audible_story_sync"

options = GoodAudibleStorySync::Options.parse(script_name: __FILE__)

audible_auth = GoodAudibleStorySync::Audible::AuthFlow.run(output_file: options.credentials_file)
if audible_auth.nil?
  exit 1
end

audible_client = GoodAudibleStorySync::Audible::Client.new(auth: audible_auth, options: options)
puts "Getting Audible user profile..."
user_profile = audible_client.get_user_profile
puts "\tAudible user ID: #{user_profile["user_id"]}"
puts "\tName: #{user_profile["name"]}"
puts "\tEmail: #{user_profile["email"]}"

puts "Getting Audible library..."
per_page = 50
all_library_items = []
total_count, page_items = audible_client.get_library(page: 1, per_page: per_page)
puts "\tLoaded #{page_items.size} of #{total_count} item(s) in library"
all_library_items.concat(page_items)
total_pages = (total_count.to_f / per_page).ceil
(2..total_pages).each do |page|
  _, page_items = audible_client.get_library(page: page, per_page: per_page)
  puts "\tLoaded #{all_library_items.size + page_items.size} of #{total_count} item(s) in library"
  all_library_items.concat(page_items)
end
File.write("audible_library.json", JSON.pretty_generate(all_library_items))
